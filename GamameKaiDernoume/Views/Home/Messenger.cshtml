@model MessengerViewModel
@{
	ViewData["Title"] = "Messenger";
}
<link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css'>
<link href="~/css/messenger.css" rel="stylesheet" />

<div id="frame">
	<div id="sidepanel">
		<div id="profile">
			<div class="wrap">
				<img id="profile-img" src="@Model.ThisUser.UserAvatar" class="online" alt="" />

				<p title="@Model.ThisUser.Id" id="userName">@Model.ThisUser.FirstName @Model.ThisUser.LastName</p>
				<i class="fa fa-chevron-down expand-button" aria-hidden="true"></i>
				<div id="status-options">
					<ul>
						<li id="status-online" class="active"><span class="status-circle"></span> <p>Online</p></li>
						<li id="status-away"><span class="status-circle"></span> <p>Away</p></li>
						<li id="status-busy"><span class="status-circle"></span> <p>Busy</p></li>
						<li id="status-offline"><span class="status-circle"></span> <p>Offline</p></li>
					</ul>
				</div>
			</div>
		</div>
		<div id="contacts">
			<ul>
				@foreach (User friend in Model.ThisUsersFriends)
				{
					var lastText = @Model.UsersMessages.Where(m => m.Receiver.Id == friend.Id || m.Sender.Id == friend.Id).LastOrDefault();
					<li class="contact" title="@friend.Id" id="friend-panel-@friend.Id" onclick="setActiveUser('@friend.Id')">
						<div class="wrap">
							<span class="contact-status offline"></span>
							<img src="@friend.UserAvatar" alt="" />
							<div class="meta">
								<p class="name">@friend.FirstName @friend.LastName</p>
								@if (lastText is null)
								{
									<p class="preview">No messages</p>
								}
								else
								{
									<p class="preview">@lastText.MessageText</p>
								}
							</div>
						</div>
					</li>
				}
			</ul>
		</div>
	</div>
	<div class="content">
		@if (Model.LatestCommunicator is null)
		{
			<div id="activeUser" title="" class="contact-profile">
				<img src="~/images/user.png" alt="" />
				<p>No Communication History</p>
			</div>
			<div class="messages">
				<ul id="active-user-messages"></ul>
			</div>
		}
		else
		{

			<div id="activeUser" title="@Model.LatestCommunicator.Id" class="contact-profile">
				<img src="@Model.LatestCommunicator.UserAvatar" alt="" />
				<p>@Model.LatestCommunicator.FirstName @Model.LatestCommunicator.LastName</p>
			</div>
			<div class="messages">
				<ul id="active-user-messages">
					@foreach (Message message in Model.UsersMessages.Where(m => m.Receiver.Id == Model.LatestCommunicator.Id || m.Sender.Id == Model.LatestCommunicator.Id))
					{
						if (message.Sender.Id == Model.ThisUser.Id)
						{
							<li class="sent">
								<img src="@Model.ThisUser.UserAvatar" alt="" />
								<p>@message.MessageText</p>
							</li>
						}
						else
						{
							<li class="replies">
								<img src="@Model.LatestCommunicator.UserAvatar" alt="" />
								<p>@message.MessageText</p>
							</li>
						}
					}
				</ul>
			</div>
		}
		<div class="message-input">
			<div class="wrap">
				<input id="messageInput" type="text" placeholder="Write your message..." />
				@*<i class="fa fa-paperclip attachment" aria-hidden="true"></i>*@
				<button id="sendButton" class="submit" onclick="SendNewMessage()"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
			</div>
		</div>
	</div>
</div>

<script src="~/lib/signalr/signalr.js"></script>
<script src="~/js/chat.js"></script>

<script>
	let allFriendsElements = Array.from(document.getElementsByClassName("contact"));
	let allFriendsIDs = [];
	
	let thisUserID = document.getElementById("userName").title;

	for (const key in allFriendsElements) {
		allFriendsIDs.push(allFriendsElements[key].title);
	}

	async function setActiveUser(userID)
	{
		const messageModel = await sendData("@Url.Action("Messenger", "Home")", userID);
		const ulMessages = document.getElementById("active-user-messages");
		ulMessages.innerHTML = "";

		const activeUserElement = document.getElementById("activeUser");
		activeUserElement.title = userID;
		activeUserElement.firstElementChild.setAttribute("src", messageModel.latestCommunicator.userAvatar);
		activeUserElement.lastElementChild.innerHTML = messageModel.latestCommunicator.firstName +" "+ messageModel.latestCommunicator.lastName;
		console.log(messageModel.usersMessages);

		const comMessages = messageModel.usersMessages;
		for (const key in comMessages) {
			if (comMessages.hasOwnProperty(key)) {
				const message = comMessages[key];
				const li = document.createElement("li");
				const img = document.createElement("img");
				const p = document.createElement("p");

				img.setAttribute("src", message.sender.userAvatar);
				p.innerHTML = message.messageText;
				if (message.sender.id === thisUserID) {
					li.setAttribute("class", "sent");
				}
				else {
					li.setAttribute("class", "replies");
				}
				li.appendChild(img);
				li.appendChild(p);
				ulMessages.appendChild(li);
			}
		}
	}

	function sendRequest(userId, message)
	{
		let data =
			{
				receiverID: userId,
				messageText: message
			};

		sendData("@Url.Action("SendMessage", "Home")", data);
	}
</script>

